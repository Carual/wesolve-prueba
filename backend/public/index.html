<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WeSolve Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Better scrollbars (Chrome/Edge/Safari + Firefox) */
        .scroll {
            overflow: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, .55) rgba(15, 23, 42, .35);
        }

        .scroll::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .scroll::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, .35);
            border-radius: 999px;
        }

        .scroll::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, .45);
            border: 2px solid rgba(15, 23, 42, .35);
            border-radius: 999px;
        }

        .scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, .65);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100">
    <div class="max-w-6xl mx-auto p-4">
        <div class="flex flex-wrap items-center gap-2 mb-3">
            <h1 class="text-lg font-bold">WeSolve ‚Äì Tester</h1>
            <span id="apiBadge" class="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">API:
                ?</span>
            <span id="sessionBadge" class="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">Not
                logged</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">
            <!-- LEFT -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40">
                <div class="p-4 border-b border-slate-800">
                    <div class="text-sm font-semibold">Session</div>
                    <div class="text-xs text-slate-400 mt-1">JWT in localStorage ‚Üí Authorization: Bearer</div>
                </div>

                <div class="p-4 space-y-3">
                    <div>
                        <label class="text-xs text-slate-400">API Base URL</label>
                        <input id="baseUrl"
                            class="mt-1 w-full rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            value="http://localhost:3001" />
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button id="btnPing"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">Ping</button>
                        <button id="btnMe"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">/me</button>
                        <button id="btnLogout"
                            class="rounded-xl border border-rose-800/60 bg-rose-900/20 px-3 py-2 text-sm font-semibold">Logout</button>
                    </div>

                    <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
                        <label class="text-xs text-slate-400">Login (POST /login)</label>
                        <input id="loginUserId"
                            class="mt-1 w-full rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            placeholder="user UUID (pick from Users)" />
                        <button id="btnLogin"
                            class="mt-2 w-full rounded-xl border border-emerald-800/60 bg-emerald-900/20 px-3 py-2 text-sm font-semibold">
                            Login
                        </button>

                        <div class="text-xs text-slate-400 mt-2">Token:</div>
                        <div id="tokenPreview" class="text-xs break-all text-slate-300 mt-1 font-mono">‚Äî</div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-semibold">Users</div>
                            <div class="text-xs text-slate-400">GET /users</div>
                        </div>
                        <button id="btnUsers"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">Refresh</button>
                    </div>
                    <div id="usersList" class="scroll max-h-[360px] pr-1 space-y-2"></div>

                    <div class="flex items-center justify-between pt-2">
                        <div>
                            <div class="text-sm font-semibold">My Matches</div>
                            <div class="text-xs text-slate-400">GET /me/matches</div>
                        </div>
                        <button id="btnMyMatches"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">Refresh</button>
                    </div>
                    <div id="myMatchesList" class="scroll max-h-[420px] pr-1 space-y-2"></div>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40">
                <div class="p-4 border-b border-slate-800">
                    <div class="text-sm font-semibold">Problems</div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-3">
                        <input id="fSearch" class="rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            placeholder="search" />
                        <input id="fCategory"
                            class="rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            placeholder="category" />
                        <input id="fLocation"
                            class="rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            placeholder="location" />
                        <input id="fCountry"
                            class="rounded-xl bg-slate-950/50 border border-slate-800 px-3 py-2 text-sm"
                            placeholder="country (US)" />
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button id="btnSearch"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">Search</button>
                        <button id="btnClear"
                            class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-sm font-semibold">Clear</button>
                        <div id="resultsMeta" class="ml-auto text-xs text-slate-400 self-center">‚Äî</div>
                    </div>
                </div>

                <div class="p-4 grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-4">
                    <div>
                        <div class="text-sm font-semibold mb-2">Results</div>
                        <div id="problemsList" class="scroll max-h-[720px] pr-1 space-y-2"></div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <div class="text-sm font-semibold">Collaborators</div>
                                <div class="text-xs text-slate-400">GET /problems/:id/users</div>
                            </div>
                            <span id="collabBadge"
                                class="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">Select</span>
                        </div>
                        <div id="collabList" class="scroll max-h-[420px] pr-1 space-y-2">
                            <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">
                                No problem selected.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        const $ = (id) => document.getElementById(id);
        const LS_TOKEN = "wesolve_token", LS_UID = "wesolve_uid";

        const state = {
            baseUrl: $("baseUrl").value.trim(),
            token: localStorage.getItem(LS_TOKEN) || "",
            userId: localStorage.getItem(LS_UID) || "",
            problems: [],
            myMatches: new Map(), // problemId -> { role, matched_at, problem }
        };

        const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[c]);

        function toast(kind, title, msg) {
            const wrap = $("toasts");
            const cls = kind === "ok"
                ? "border-emerald-800/60 bg-emerald-900/20"
                : kind === "bad"
                    ? "border-rose-800/60 bg-rose-900/20"
                    : "border-slate-700 bg-slate-800/60";
            const el = document.createElement("div");
            el.className = `w-[360px] max-w-[calc(100vw-2rem)] rounded-xl border ${cls} p-3 shadow-lg`;
            el.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="flex-1">
          <div class="text-sm font-semibold">${escapeHtml(title)}</div>
          ${msg ? `<div class="text-xs text-slate-200/80 mt-1 break-words">${escapeHtml(msg)}</div>` : ""}
        </div>
        <button class="text-slate-300 hover:text-white text-lg leading-none px-2">√ó</button>
      </div>`;
            el.querySelector("button").onclick = () => el.remove();
            wrap.appendChild(el);
            setTimeout(() => el.isConnected && el.remove(), 4200);
        }

        const apiUrl = (path) => state.baseUrl.replace(/\/+$/, "") + path;

        async function apiFetch(path, { method = "GET", body = null } = {}, authed = false) {
            const headers = { "Content-Type": "application/json" };
            if (authed) {
                if (!state.token) throw new Error("No token. Login first.");
                headers.Authorization = "Bearer " + state.token;
            }
            const res = await fetch(apiUrl(path), { method, headers, body: body ? JSON.stringify(body) : null });
            const text = await res.text();
            let json = null; try { json = text ? JSON.parse(text) : null; } catch { }
            if (!res.ok) throw new Error((json && json.error) ? json.error : (text || res.statusText));
            return json;
        }

        function setBadges() {
            $("sessionBadge").textContent = state.token ? `Logged: ${state.userId?.slice(0, 8)}‚Ä¶` : "Not logged";
            $("tokenPreview").textContent = state.token || "‚Äî";
        }

        function qProblems() {
            const p = new URLSearchParams();
            const s = $("fSearch").value.trim();
            const c = $("fCategory").value.trim();
            const l = $("fLocation").value.trim();
            const cc = $("fCountry").value.trim().toUpperCase();
            if (s) p.set("search", s);
            if (c) p.set("category", c);
            if (l) p.set("location", l);
            if (cc) p.set("country_code", cc);
            const qs = p.toString();
            return qs ? `?${qs}` : "";
        }

        async function ping() {
            try { await apiFetch("/health"); $("apiBadge").textContent = "API: OK"; }
            catch { $("apiBadge").textContent = "API: FAIL"; }
        }

        // -------- USERS
        async function loadUsers() {
            const list = $("usersList");
            list.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">Loading‚Ä¶</div>`;
            try {
                const data = await apiFetch("/users");
                const items = data.items || [];
                list.innerHTML = items.length ? "" : `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">No users.</div>`;
                for (const u of items) {
                    const el = document.createElement("div");
                    el.className = "rounded-xl border border-slate-800 bg-slate-950/30 p-3";
                    el.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${escapeHtml(u.display_name || "Unnamed")}</div>
              <div class="text-xs text-slate-400 font-mono break-all mt-1">${escapeHtml(u.id)}</div>
            </div>
            <button class="shrink-0 rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-xs font-semibold">Use</button>
          </div>`;
                    el.querySelector("button").onclick = () => { $("loginUserId").value = u.id; toast("ok", "User selected", ""); };
                    list.appendChild(el);
                }
            } catch (e) {
                list.innerHTML = `<div class="rounded-xl border border-rose-800/60 bg-rose-900/20 p-3 text-xs">${escapeHtml(e.message)}</div>`;
            }
        }

        // -------- AUTH
        async function login() {
            const userId = $("loginUserId").value.trim();
            if (!userId) return toast("bad", "Missing userId", "Pick one from Users list.");
            try {
                const data = await apiFetch("/login", { method: "POST", body: { userId } });
                state.token = data.token || "";
                state.userId = data.user?.id || userId;
                localStorage.setItem(LS_TOKEN, state.token);
                localStorage.setItem(LS_UID, state.userId);
                setBadges();
                toast("ok", "Logged in", data.user?.display_name || state.userId);
                await loadMyMatches();
            } catch (e) {
                toast("bad", "Login failed", e.message);
            }
        }

        function logout() {
            state.token = ""; state.userId = "";
            localStorage.removeItem(LS_TOKEN); localStorage.removeItem(LS_UID);
            state.myMatches.clear();
            setBadges();
            renderMyMatches();
            toast("ok", "Logged out", "");
        }

        async function me() {
            try {
                const data = await apiFetch("/me", {}, true);
                toast("ok", "/me", `${data.user.display_name || "Unnamed"}`);
            } catch (e) {
                toast("bad", "/me failed", e.message);
            }
        }

        // -------- MY MATCHES (NEW: server-driven)
        async function loadMyMatches() {
            const box = $("myMatchesList");
            if (!state.token) { renderMyMatches(); return; }
            box.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">Loading‚Ä¶</div>`;
            try {
                const data = await apiFetch("/me/matches?limit=300", {}, true);
                state.myMatches.clear();
                for (const r of (data.items || [])) {
                    state.myMatches.set(r.problem.id, { role: r.role, matched_at: r.matched_at, problem: r.problem });
                }
                renderMyMatches();
                renderProblems(); // update chips
            } catch (e) {
                box.innerHTML = `<div class="rounded-xl border border-rose-800/60 bg-rose-900/20 p-3 text-xs">${escapeHtml(e.message)}</div>`;
            }
        }

        function renderMyMatches() {
            const box = $("myMatchesList");
            box.innerHTML = "";
            if (!state.token) {
                box.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">Login to see matches.</div>`;
                return;
            }
            const items = Array.from(state.myMatches.values());
            if (!items.length) {
                box.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">No matches.</div>`;
                return;
            }
            for (const m of items) {
                const p = m.problem;
                const el = document.createElement("div");
                el.className = "rounded-xl border border-slate-800 bg-slate-950/30 p-3";
                el.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-sm font-semibold">${escapeHtml(p.title)}</div>
            <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-2">
              <span class="px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">${escapeHtml(m.role)}</span>
              <span class="px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">üìç ${escapeHtml(p.location)}</span>
            </div>
            <div class="text-[11px] text-slate-500 font-mono break-all mt-2">${escapeHtml(p.id)}</div>
          </div>
          <div class="shrink-0 flex flex-col gap-2">
            <button data-act="users" class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-xs font-semibold">Users</button>
            <button data-act="unmatch" class="rounded-xl border border-rose-800/60 bg-rose-900/20 px-3 py-2 text-xs font-semibold">Unmatch</button>
          </div>
        </div>`;
                el.querySelector('[data-act="users"]').onclick = () => loadCollaborators(p.id);
                el.querySelector('[data-act="unmatch"]').onclick = () => unmatch(p);
                box.appendChild(el);
            }
        }

        // -------- PROBLEMS
        async function loadProblems() {
            const list = $("problemsList");
            list.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">Loading‚Ä¶</div>`;
            try {
                const data = await apiFetch("/problems" + qProblems());
                state.problems = data.items || [];
                $("resultsMeta").textContent = `${state.problems.length} problems`;
                renderProblems();
            } catch (e) {
                list.innerHTML = `<div class="rounded-xl border border-rose-800/60 bg-rose-900/20 p-3 text-xs">${escapeHtml(e.message)}</div>`;
                $("resultsMeta").textContent = "Error";
            }
        }

        function renderProblems() {
            const list = $("problemsList");
            list.innerHTML = "";
            if (!state.problems.length) {
                list.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">No results.</div>`;
                return;
            }
            for (const p of state.problems) {
                const my = state.myMatches.get(p.id);
                const el = document.createElement("div");
                el.className = "rounded-xl border border-slate-800 bg-slate-950/30 p-3";
                el.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-sm font-semibold">${escapeHtml(p.title)}</div>
            <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-2">
              <span class="px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">üè∑ ${escapeHtml(p.category)}</span>
              <span class="px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">üìç ${escapeHtml(p.location)}</span>
              <span class="px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">üåç ${escapeHtml(p.country_code || "‚Äî")}</span>
              ${my ? `<span class="px-2 py-1 rounded-full border border-emerald-800/60 bg-emerald-900/20">üôã You: ${escapeHtml(my.role)}</span>` : ``}
            </div>
            <div class="text-xs text-slate-300 mt-2">${escapeHtml((p.description || "").slice(0, 140))}${(p.description || "").length > 140 ? "‚Ä¶" : ""}</div>
            <div class="text-[11px] text-slate-500 font-mono break-all mt-2">${escapeHtml(p.id)}</div>
          </div>
          <div class="shrink-0 flex flex-col gap-2">
            <button data-act="users" class="rounded-xl border border-slate-800 bg-slate-800/50 px-3 py-2 text-xs font-semibold">Users</button>
            <button data-act="solver" class="rounded-xl border border-emerald-800/60 bg-emerald-900/20 px-3 py-2 text-xs font-semibold">Match SOLVER</button>
            <button data-act="aff" class="rounded-xl border border-emerald-800/60 bg-emerald-900/20 px-3 py-2 text-xs font-semibold">Match AFFECTED</button>
            <button data-act="unmatch" class="rounded-xl border border-rose-800/60 bg-rose-900/20 px-3 py-2 text-xs font-semibold">Unmatch</button>
          </div>
        </div>`;
                el.querySelector('[data-act="users"]').onclick = () => loadCollaborators(p.id);
                el.querySelector('[data-act="solver"]').onclick = () => match(p, "SOLVER");
                el.querySelector('[data-act="aff"]').onclick = () => match(p, "AFFECTED");
                el.querySelector('[data-act="unmatch"]').onclick = () => unmatch(p);
                list.appendChild(el);
            }
        }

        async function match(p, role) {
            try {
                await apiFetch(`/problems/${p.id}/match`, { method: "POST", body: { role } }, true);
                toast("ok", "Matched ‚úÖ", `${p.title} ‚Äî ${role}`);
                await loadMyMatches();
                await loadProblems();
            } catch (e) {
                toast("bad", "Match failed", e.message);
            }
        }

        async function unmatch(p) {
            try {
                await apiFetch(`/problems/${p.id}/match`, { method: "DELETE" }, true);
                toast("ok", "Unmatched", p.title);
                await loadMyMatches();
                await loadProblems();
                if ($("collabBadge").textContent !== "Select") await loadCollaborators(p.id).catch(() => { });
            } catch (e) {
                toast("bad", "Unmatch failed", e.message);
            }
        }

        // -------- COLLABORATORS
        async function loadCollaborators(problemId) {
            $("collabBadge").textContent = "Loading‚Ä¶";
            const list = $("collabList");
            list.innerHTML = `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">Loading‚Ä¶</div>`;
            try {
                const data = await apiFetch(`/problems/${problemId}/users`);
                const items = data.items || [];
                $("collabBadge").textContent = `${items.length} users`;
                list.innerHTML = items.length ? "" : `<div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 text-xs text-slate-400">No users.</div>`;
                for (const r of items) {
                    const el = document.createElement("div");
                    el.className = "rounded-xl border border-slate-800 bg-slate-950/30 p-3";
                    el.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${escapeHtml(r.user?.display_name || "Unnamed")}</div>
              <div class="text-[11px] text-slate-500 font-mono break-all mt-1">${escapeHtml(r.user?.id || "")}</div>
              <div class="text-[11px] text-slate-400 mt-1">matched_at: <span class="font-mono">${escapeHtml(r.matched_at || "")}</span></div>
            </div>
            <span class="text-xs px-2 py-1 rounded-full border border-slate-800 bg-slate-800/50">${escapeHtml(r.role || "")}</span>
          </div>`;
                    list.appendChild(el);
                }
            } catch (e) {
                $("collabBadge").textContent = "Error";
                list.innerHTML = `<div class="rounded-xl border border-rose-800/60 bg-rose-900/20 p-3 text-xs">${escapeHtml(e.message)}</div>`;
            }
        }

        // -------- Events
        $("baseUrl").addEventListener("change", () => { state.baseUrl = $("baseUrl").value.trim(); toast("ok", "Base URL updated", state.baseUrl); });

        $("btnPing").onclick = ping;
        $("btnUsers").onclick = loadUsers;
        $("btnLogin").onclick = login;
        $("btnLogout").onclick = logout;
        $("btnMe").onclick = me;
        $("btnSearch").onclick = loadProblems;
        $("btnClear").onclick = () => { ["fSearch", "fCategory", "fLocation", "fCountry"].forEach(id => $(id).value = ""); loadProblems(); toast("ok", "Cleared", ""); };
        $("btnMyMatches").onclick = loadMyMatches;

        ["fSearch", "fCategory", "fLocation", "fCountry"].forEach(id => $(id).addEventListener("keydown", e => e.key === "Enter" && loadProblems()));

        // -------- Init
        (async function init() {
            setBadges();
            await ping();
            await loadUsers();
            await loadProblems();
            if (state.token && state.userId) await loadMyMatches();
            else renderMyMatches();
        })();
    </script>
</body>

</html>